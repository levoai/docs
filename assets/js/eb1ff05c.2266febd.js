"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5801],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return m}});var a=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var o=a.createContext({}),c=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(o.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,r=e.originalType,o=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(n),m=s,h=d["".concat(o,".").concat(m)]||d[m]||p[m]||r;return n?a.createElement(h,i(i({ref:t},u),{},{components:n})):a.createElement(h,i({ref:t},u))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l.mdxType="string"==typeof e?e:s,i[1]=l;for(var c=2;c<r;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3798:function(e,t,n){n.r(t),n.d(t,{assets:function(){return u},contentTitle:function(){return o},default:function(){return m},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var a=n(3117),s=n(102),r=(n(7294),n(3905)),i=["components"],l={sidebar_position:4},o="Satellite on AWS EKS",c={unversionedId:"install-satellite/satellite-aws-eks",id:"install-satellite/satellite-aws-eks",title:"Satellite on AWS EKS",description:"AWS EKS supports two compute types for its nodes, EC2 and Fargate. Depending on your usecase, you can follow the installation steps given below.",source:"@site/docs/install-satellite/satellite-aws-eks.md",sourceDirName:"install-satellite",slug:"/install-satellite/satellite-aws-eks",permalink:"/install-satellite/satellite-aws-eks",draft:!1,editUrl:"https://github.com/levoai/docs/edit/main/docs/install-satellite/satellite-aws-eks.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Satellite AMI on AWS EC2",permalink:"/install-satellite/satellite-ami-aws-ec2"},next:{title:"Satellite on AWS EKS using Fargate",permalink:"/install-satellite/satellite-aws-eks-fargate"}},u={},p=[{value:"Prerequisites",id:"prerequisites",level:3},{value:"Install in AWS EKS using EC2",id:"install-in-aws-eks-using-ec2",level:2},{value:"1. Setup environment variables",id:"1-setup-environment-variables",level:3},{value:"2. Cluster Creation",id:"2-cluster-creation",level:3},{value:"3. Connecting to the cluster",id:"3-connecting-to-the-cluster",level:3},{value:"Adding individuals to the cluster",id:"adding-individuals-to-the-cluster",level:4},{value:"Giving access to an IAM User Group",id:"giving-access-to-an-iam-user-group",level:4},{value:"4. Setting the cluster up",id:"4-setting-the-cluster-up",level:3},{value:"Creating an OIDC provider",id:"creating-an-oidc-provider",level:4},{value:"5. Install the satellite",id:"5-install-the-satellite",level:3}],d={toc:p};function m(e){var t=e.components,n=(0,s.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"satellite-on-aws-eks"},"Satellite on AWS EKS"),(0,r.kt)("p",null,"AWS EKS supports two compute types for its nodes, EC2 and Fargate. Depending on your usecase, you can follow the installation steps given below."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/install-satellite/satellite-aws-ecs"},"Install using EC2")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"/install-satellite/satellite-aws-eks-fargate"},"Install using Fargate"))),(0,r.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://eksctl.io/"},"eksctl")," version >= ",(0,r.kt)("inlineCode",{parentName:"li"},"v0.152.0")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"https://helm.sh/docs/intro/install/"},"Helm v3")," installed and working on your local machine."),(0,r.kt)("li",{parentName:"ul"},"An AWS account with EKS permissions.")),(0,r.kt)("h2",{id:"install-in-aws-eks-using-ec2"},"Install in AWS EKS using EC2"),(0,r.kt)("h3",{id:"1-setup-environment-variables"},"1. Setup environment variables"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"export CLUSTER_NAME='Cluster Name'\nexport REGION='AWS Region'\nexport ACCOUNT_ID='AWS Account ID'\n")),(0,r.kt)("h3",{id:"2-cluster-creation"},"2. Cluster Creation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"read -r -d '' EKS_CLUSTER <<EOF\napiVersion: eksctl.io/v1alpha5\nkind: ClusterConfig\n\nmetadata:\n  name: ${CLUSTER_NAME}\n  region: ${REGION}\n\nvpc:\n  subnets:\n    private:\n      # MENTION THE SUBNETS YOU WANT TO USE FOR YOUR SATELLITE\n      # FOR EXAMPLE:\n      # us-west-2a: { id: subnet-0d09e999a579234ea }\n      # us-west-2b: { id: subnet-0d09e999a579234eb }\n\nnodeGroups:\n  - name: ng-e2e\n    instanceType: t2.xlarge\n    desiredCapacity: 1\n    volumeSize: 40\n    privateNetworking: true\nEOF\n\necho \"${EKS_CLUSTER}\" > eks-cluster.yaml\n\neksctl create cluster -f ./configuration/eks-cluster.yaml\n")),(0,r.kt)("h3",{id:"3-connecting-to-the-cluster"},"3. Connecting to the cluster"),(0,r.kt)("p",null,"AWS EKS grants cluster admin permissions to the account from which the cluster is created. If you don't need access to the cluster for other AWS Users, you can skip this section."),(0,r.kt)("p",null,"Access to other AWS users in the same account can be granted via 2 ways."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#adding-individuals-to-the-cluster"},"Adding individual access to user accounts")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("a",{parentName:"li",href:"#giving-access-to-an-iam-user-group"},"Giving the permissions to a user group"))),(0,r.kt)("h4",{id:"adding-individuals-to-the-cluster"},"Adding individuals to the cluster"),(0,r.kt)("p",null,"This command can be run to add an inidividual user account to the cluster's aws-auth configmap"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"eksctl create iamidentitymapping \\\n    --cluster ${CLUSTER_NAME} \\\n    --region ${REGION} \\\n    --arn <AWS ACCOUNT ARN FOR THE USER> \\\n    --group system:masters \\\n    --no-duplicate-arns \\\n    --username <AWS USERNAME FOR THE USER>\n")),(0,r.kt)("h4",{id:"giving-access-to-an-iam-user-group"},"Giving access to an IAM User Group"),(0,r.kt)("p",null,"We create a role developer.assume-access.role and attach two policies to it. The first one is ",(0,r.kt)("inlineCode",{parentName:"p"},"EKSFullAccess")," so that it has access to all the EKS resources. The second one is ",(0,r.kt)("inlineCode",{parentName:"p"},"developer.assume-eks-access-role.policy")," that allows assuming the role."),(0,r.kt)("p",null,"A detailed guide on defining the roles and policies can be found ",(0,r.kt)("a",{parentName:"p",href:"https://eng.grip.security/enabling-aws-iam-group-access-to-an-eks-cluster-using-rbac"},"here"),"."),(0,r.kt)("p",null,"Once you have followed the above guide to create the roles and attach the specific policies, you can add the role to the cluster's aws-auth config map to let the developers group access the cluster"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"eksctl create iamidentitymapping \\\n    --cluster ${CLUSTER_NAME} \\\n    --region ${REGION} \\\n    --arn arn:aws:iam::${ACCOUND_ID}:role/developer.assume-access.role \\\n    --group system:masters \\\n")),(0,r.kt)("p",null,"This needs to be run in order to grant access to the cluster."),(0,r.kt)("p",null,"One can Connect to the cluster by running just a single command"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"aws eks update-kubeconfig --name ${CLUSTER_NAME} --region ${REGION}> --role-arn arn:aws:iam::${ACCOUNT_ID}:role/developer.assume-access.role\n")),(0,r.kt)("p",null,"This commands updates the kubeconfig and adds the context for the cluster and sets the current context to it.\nThe ",(0,r.kt)("inlineCode",{parentName:"p"},"--role")," argument sets the correct role and policies so that seemless access to the cluster is granted instantly."),(0,r.kt)("h3",{id:"4-setting-the-cluster-up"},"4. Setting the cluster up"),(0,r.kt)("h4",{id:"creating-an-oidc-provider"},"Creating an OIDC provider"),(0,r.kt)("p",null,"Run these two commands:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"oidc_id=$(aws eks describe-cluster --name ${CLUSTER_NAME} --region ${REGION} --query \"cluster.identity.oidc.issuer\" --output text | cut -d '/' -f 5)\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'aws iam list-open-id-connect-providers | grep $oidc_id | cut -d "/" -f4 | cut -d "\\"" -f1\n')),(0,r.kt)("p",null,"If this returns a value, that is the OIDC ID that we need. If the statement returns nothing, run this command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"eksctl utils associate-iam-oidc-provider --cluster ${CLUSTER_NAME} --region ${REGION} --approve\n")),(0,r.kt)("p",null,"This creates an OIDC Identity Provider."),(0,r.kt)("p",null,"Next, to create a role in AWS for the EBS CSI Driver add-on (",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html"},"Amazon Elastic Block Store CSI Driver")," manages persistent volumes in EKS) we need to run these:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'OIDC=$(aws iam list-open-id-connect-providers | grep $oidc_id | cut -d "/" -f4 | cut -d "\\"" -f1)\n\nread -r -d \'\' EBS_DRIVER_POLICY <<EOF\n{\n"Version": "2012-10-17",\n"Statement": [\n    {\n    "Sid": "",\n    "Effect": "Allow",\n    "Principal": {\n        "Federated": "arn:aws:iam::${ACCOUNT_ID}:oidc-provider/oidc.eks.${REGION}.amazonaws.com/id/${OIDC}"\n    },\n    "Action": "sts:AssumeRoleWithWebIdentity",\n    "Condition": {\n        "StringEquals": {\n        "oidc.eks.${REGION}.amazonaws.com/id/${OIDC}:aud": "sts.amazonaws.com",\n        "oidc.eks.${REGION}.amazonaws.com/id/${OIDC}:sub": "system:serviceaccount:kube-system:ebs-csi-controller-sa"\n        }\n    }\n    }\n]\n}\nEOF\necho "${EBS_DRIVER_POLICY}" > aws-ebs-csi-driver-trust-policy.json\n\naws iam create-role \\\n  --role-name AmazonEKS_EBS_CSI_DriverRole \\\n  --assume-role-policy-document file://aws-ebs-csi-driver-trust-policy.json\n\naws iam attach-role-policy \\\n  --policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \\\n  --role-name AmazonEKS_EBS_CSI_DriverRole\n\neksctl create addon --name aws-ebs-csi-driver --cluster ${CLUSTER_NAME} --region ${REGION} --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKS_EBS_CSI_DriverRole \u2014force\n')),(0,r.kt)("h3",{id:"5-install-the-satellite"},"5. Install the satellite"),(0,r.kt)("p",null,"Please follow the instructions in the ",(0,r.kt)("a",{parentName:"p",href:"/install-satellite/satellite-kubernetes"},"Install on Kubernetes")," section to install the Satellite."),(0,r.kt)("p",null,"Please ensure that you note down the address of the collector."))}m.isMDXComponent=!0}}]);